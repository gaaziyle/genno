# Create Blog Edge Function

This Supabase Edge Function receives blog data from your n8n workflow and creates a blog entry in the database.

## Purpose

When n8n processes a YouTube video and generates blog content, it sends the data to this Edge Function, which:

1. ‚úÖ Validates the data
2. ‚úÖ Generates a unique slug
3. ‚úÖ Creates a unique blog ID (UUID)
4. ‚úÖ Inserts the blog into Supabase
5. ‚úÖ Returns the created blog information

## Setup

### 1. Deploy the Edge Function

```bash
# Make sure you're in the project root
cd c:\Users\muham\Desktop\genno

# Login to Supabase (if not already)
supabase login

# Link to your project (if not already)
supabase link --project-ref YOUR_PROJECT_REF

# Deploy the function
supabase functions deploy create-blog
```

### 2. Set Environment Variables

The function uses these environment variables (automatically available):

- `SUPABASE_URL` - Your Supabase project URL
- `SUPABASE_SERVICE_ROLE_KEY` - Service role key (bypasses RLS)

These are automatically set by Supabase when you deploy.

### 3. Get the Function URL

After deployment, you'll get a URL like:

```
https://YOUR_PROJECT_REF.supabase.co/functions/v1/create-blog
```

## Usage

### Request Format

Send a POST request with this JSON body:

```json
{
  "clerk_user_id": "user_xxx",
  "title": "Blog Title",
  "content": "Full blog content in HTML or markdown",
  "excerpt": "Brief summary (optional)",
  "youtube_url": "https://youtube.com/watch?v=xxx",
  "thumbnail_url": "https://img.youtube.com/vi/xxx/maxresdefault.jpg (optional)",
  "slug": "custom-slug (optional, will auto-generate if not provided)",
  "tags": ["tag1", "tag2"] (optional)
}
```

### Response Format

**Success (200):**

```json
{
  "success": true,
  "message": "Blog created successfully",
  "blog": {
    "id": "uuid-here",
    "title": "Blog Title",
    "slug": "blog-title-abc123",
    "clerk_user_id": "user_xxx",
    "is_publish": false,
    "created_at": "2024-01-01T00:00:00.000Z"
  }
}
```

**Error (400):**

```json
{
  "success": false,
  "error": "Error message",
  "details": "Detailed error information"
}
```

## n8n Integration

### Configure n8n Workflow

In your n8n workflow, after processing the YouTube video, add an HTTP Request node:

**HTTP Request Node Settings:**

- **Method:** POST
- **URL:** `https://YOUR_PROJECT_REF.supabase.co/functions/v1/create-blog`
- **Authentication:** None (or use API key if you add auth)
- **Body:**
  ```json
  {
    "clerk_user_id": "{{ $json.clerk_user_id }}",
    "title": "{{ $json.title }}",
    "content": "{{ $json.content }}",
    "excerpt": "{{ $json.excerpt }}",
    "youtube_url": "{{ $json.youtubeUrl }}",
    "thumbnail_url": "{{ $json.thumbnail_url }}",
    "tags": {{ $json.tags }}
  }
  ```

## Features

### Automatic Slug Generation

If you don't provide a slug, the function automatically generates one:

- Converts title to lowercase
- Replaces special characters with hyphens
- Adds random suffix for uniqueness
- Example: "My Blog Post" ‚Üí "my-blog-post-abc12345"

### Unique Blog IDs

Each blog gets a unique UUID automatically:

- Generated by PostgreSQL: `uuid_generate_v4()`
- No collisions possible
- Format: `550e8400-e29b-41d4-a716-446655440000`

### Bypasses RLS

Uses service role key to bypass Row Level Security:

- Creates blogs for any user
- No authentication needed for the function itself
- Secure because it's server-side only

## Testing

### Test with curl

```bash
curl -X POST \
  https://YOUR_PROJECT_REF.supabase.co/functions/v1/create-blog \
  -H "Content-Type: application/json" \
  -d '{
    "clerk_user_id": "user_test123",
    "title": "Test Blog Post",
    "content": "This is test content for my blog post.",
    "excerpt": "A test blog post",
    "youtube_url": "https://youtube.com/watch?v=test"
  }'
```

### Test from n8n

1. Create a new workflow
2. Add "Execute Workflow Trigger"
3. Add "HTTP Request" node
4. Configure with the URL and body above
5. Click "Execute Node"
6. Check response in n8n
7. Verify in Supabase Table Editor

## Verification

After creating a blog, verify it in Supabase:

```sql
-- Check the latest blog
SELECT
    id,
    title,
    slug,
    clerk_user_id,
    is_publish,
    created_at
FROM blogs
ORDER BY created_at DESC
LIMIT 5;

-- Count blogs per user
SELECT
    clerk_user_id,
    COUNT(*) as blog_count
FROM blogs
GROUP BY clerk_user_id;
```

## Workflow Integration

### Complete Flow

```
1. User submits YouTube URL ‚Üí Frontend
2. Frontend sends to n8n webhook
3. n8n processes video:
   - Extracts transcript
   - Generates blog content with AI
   - Creates title, excerpt, tags
4. n8n calls create-blog Edge Function
5. Edge Function creates blog in Supabase
6. User sees new blog in dashboard
```

### n8n Webhook Response

Your n8n webhook should return:

```json
{
  "clerk_user_id": "{{ received from frontend }}",
  "title": "{{ generated by AI }}",
  "content": "{{ generated by AI }}",
  "excerpt": "{{ generated by AI }}",
  "youtube_url": "{{ from frontend }}",
  "thumbnail_url": "{{ extracted from YouTube }}",
  "tags": ["{{ generated by AI }}"]
}
```

Then send this data to the create-blog Edge Function.

## Error Handling

### Common Errors

**"clerk_user_id is required"**

- Make sure you're passing the clerk_user_id from the frontend

**"title is required"**

- Ensure your AI generates a title

**"content is required"**

- Ensure your AI generates content

**"duplicate key value violates unique constraint"**

- The slug already exists (very rare with random suffix)
- Try regenerating or use a different title

## Security

### Current Setup

- ‚úÖ Uses service role key (server-side only)
- ‚úÖ CORS enabled for all origins
- ‚úÖ Validates required fields
- ‚ö†Ô∏è No authentication on the function itself

### Production Recommendations

For production, add authentication:

```typescript
// Add API key check
const apiKey = req.headers.get("x-api-key");
if (apiKey !== Deno.env.get("N8N_API_KEY")) {
  throw new Error("Unauthorized");
}
```

Or use Supabase function secrets:

```bash
supabase secrets set N8N_API_KEY=your_secret_key
```

## Monitoring

### Check Function Logs

```bash
# View live logs
supabase functions logs create-blog --tail

# View recent logs
supabase functions logs create-blog
```

### Common Log Messages

- "Received blog data: ..." - Function received request
- "Creating blog with data: ..." - About to insert
- "Blog created successfully: ..." - Success
- "Error inserting blog: ..." - Database error

## Updates

To update the function after making changes:

```bash
supabase functions deploy create-blog
```

## Summary

This Edge Function ensures:

- ‚úÖ Unique blog IDs (UUID)
- ‚úÖ Unique slugs (with random suffix)
- ‚úÖ Data validation
- ‚úÖ Error handling
- ‚úÖ CORS support
- ‚úÖ Bypasses RLS for server-side operations

**Your blogs will always have unique IDs!** üéâ
